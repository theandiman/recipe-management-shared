name: Manual Publish

on:
  workflow_dispatch:
    inputs:
      publish_npm:
        description: 'Whether to publish the npm package (true/false)'
        required: false
        default: 'true'
        type: string
      publish_maven:
        description: 'Whether to publish the Maven package (true/false)'
        required: false
        default: 'true'
        type: string

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    concurrency:
      group: manual-publish-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Determine version and tag
        id: determine_tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [ -z "$VERSION" ]; then
            echo "Unable to determine version from package.json" >&2
            exit 1
          fi
          TAG="v$VERSION"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Ensure tag doesn't already exist remotely
        id: check_tag
        run: |
          TAG=${{ steps.determine_tag.outputs.tag }}
          if git ls-remote --exit-code --tags origin "refs/tags/${TAG}"; then
            echo "Tag ${TAG} already exists on origin" >&2
            exit 1
          fi

      - name: Create tag on HEAD and push
        run: |
          TAG=${{ steps.determine_tag.outputs.tag }}
          MESSAGE="Release ${TAG}"
          git tag -a "$TAG" -m "$MESSAGE"
          git push origin "$TAG"

      - name: Re-check registry for version (race prevention)
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          VERSION_TO_PUBLISH=$(node -p "require('./package.json').version")
          echo "Re-checking registry for $PACKAGE_NAME@$VERSION_TO_PUBLISH"
          set +e
          EXISTING=$(npm view "${PACKAGE_NAME}@${VERSION_TO_PUBLISH}" version --registry=https://npm.pkg.github.com || true)
          set -e
          if [ "${EXISTING}" = "${VERSION_TO_PUBLISH}" ]; then
            echo "Version ${VERSION_TO_PUBLISH} was published since the initial check. Aborting." >&2
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://npm.pkg.github.com/'


      - name: Setup Java and Maven
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
          server-id: github
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.GITHUB_TOKEN }}

      # Using GITHUB_TOKEN for Maven deploy (server id 'github' uses settings.xml from setup-java)

      - name: Verify tag matches package.json and pom.xml
        id: verify_versions
        run: |
          TAG=${{ steps.determine_tag.outputs.tag }}
          # Accept tags with or without a leading 'v'
          TAG_VER=${TAG#v}
          NPM_VER=$(node -p "require('./package.json').version")
          if [ "$NPM_VER" != "$TAG_VER" ]; then
            echo "package.json version ($NPM_VER) does not match tag ($TAG_VER)" >&2
            exit 1
          fi
          # Use maven to reliably query the version from pom.xml
          POM_VER=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          if [ -z "$POM_VER" ]; then
            echo "Unable to determine version from pom.xml via Maven help:evaluate" >&2
            exit 1
          fi
          if [ "$POM_VER" != "$TAG_VER" ]; then
            echo "pom.xml version ($POM_VER) does not match tag ($TAG_VER)" >&2
            exit 1
          fi

      - name: Publish npm package
        if: ${{ inputs.publish_npm == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Determine package scope (owner) and validate existence
          SCOPE=$(node -p "require('./package.json').name.split('/')[0].slice(1)")
          echo "Publishing under scope: $SCOPE"
          # Check org or user existence via GitHub API
          if ! curl -sf -H "Authorization: token ${GITHUB_TOKEN}" "https://api.github.com/orgs/$SCOPE" >/dev/null; then
            if ! curl -sf -H "Authorization: token ${GITHUB_TOKEN}" "https://api.github.com/users/$SCOPE" >/dev/null; then
              echo "Package scope owner '$SCOPE' not found on GitHub. Please verify the package name scope in package.json or create the org/user." >&2
              exit 1
            fi
          fi
          # Prefer an NPM PAT (secrets.NPM_TOKEN) if present, otherwise fallback to GITHUB_TOKEN
          # Prefer a provided NPM_TOKEN (PAT); otherwise fallback to GITHUB_TOKEN
          AUTH_TOKEN="${NPM_TOKEN:-$GITHUB_TOKEN}"
          # Write npm auth to .npmrc for publishing to GitHub Packages
          echo "@${SCOPE}:registry=https://npm.pkg.github.com/" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${AUTH_TOKEN}" >> .npmrc
          npm ci
          npm run build
          # Check if the version already exists in GitHub Packages to avoid re-publish conflicts
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          VERSION_TO_PUBLISH=$(node -p "require('./package.json').version")
          echo "Checking registry for $PACKAGE_NAME@$VERSION_TO_PUBLISH"
          set +e
          EXISTING=$(npm view "${PACKAGE_NAME}@${VERSION_TO_PUBLISH}" version --registry=https://npm.pkg.github.com || true)
          set -e
          if [ "${EXISTING}" = "${VERSION_TO_PUBLISH}" ]; then
            echo "Version ${VERSION_TO_PUBLISH} already published to registry. Aborting publish." >&2
            exit 1
          fi
          npm publish --registry=https://npm.pkg.github.com --access public

      - name: Publish Maven package
        if: ${{ inputs.publish_maven == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          set -e
          # Resolve GAV using Maven
          GROUP_ID=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.groupId)
          ARTIFACT_ID=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.artifactId)
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          GROUP_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')
          AUTH_USER=${GITHUB_ACTOR}
          AUTH_TOKEN=${GITHUB_TOKEN}
          URL="https://maven.pkg.github.com/${{ github.repository }}/$GROUP_PATH/$ARTIFACT_ID/$VERSION/$ARTIFACT_ID-$VERSION.pom"
          echo "Checking Maven registry for $URL"
          set +e
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -u ${AUTH_USER}:${AUTH_TOKEN} "$URL")
          set -e
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Artifact $ARTIFACT_ID:$VERSION already exists in Maven registry. Aborting." >&2
            exit 1
          fi
          # Diagnostic: print sanitized settings.xml and server username
          echo "Sanity check: ~/.m2/settings.xml (password masked)"
          sed -n '1,200p' $HOME/.m2/settings.xml | sed 's/<password>.*<\/password>/<password>***<\/password>/g' || true
          echo "Maven server username:" && grep -oP '(?<=<username>).*?(?=</username>)' $HOME/.m2/settings.xml || true
          echo "Test HEAD to artifact URL (HTTP status):"; curl -s -o /dev/null -w "%{http_code}" -u ${AUTH_USER}:${AUTH_TOKEN} "$URL" || true
          mvn -B -DskipTests deploy -s $HOME/.m2/settings.xml

      - name: Bump versions (post-publish)
        if: ${{ success() && (inputs.publish_npm == 'true' || inputs.publish_maven == 'true') }}
        id: bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # Only bump when previous steps succeeded â€” check GITHUB_STEP_SUMMARY?
          # If publishing steps had failed, the job would have failed already unless they were 'if: always()'
          # Bump npm package version without adding a git tag - patch only
          npm version patch --no-git-tag-version
          NEW_VER=$(node -p "require('./package.json').version")
          echo "New npm version: $NEW_VER"
          # Set Maven version to match
          mvn -B org.codehaus.mojo:versions-maven-plugin:2.10:set -DnewVersion=$NEW_VER -DgenerateBackupPoms=false
          git add package.json package-lock.json pom.xml
          git commit -m "chore(release): bump version to $NEW_VER [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main
